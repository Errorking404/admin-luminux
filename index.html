<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üî• LUMINUX ADMIN PANEL</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            color: white; min-height: 100vh; 
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { 
            text-align: center; margin-bottom: 40px; 
            background: rgba(255,255,255,0.1); padding: 30px; border-radius: 20px; 
            backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2);
        }
        .header h1 { font-size: 2.5em; background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .stat-card { 
            background: rgba(255,255,255,0.1); padding: 25px; border-radius: 15px; 
            backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2);
            text-align: center; transition: transform 0.3s;
        }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-number { font-size: 2.5em; font-weight: bold; background: linear-gradient(45deg, #4ecdc4, #45b7d1); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .nav-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .nav-btn { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            border: none; padding: 20px 30px; border-radius: 15px; 
            color: white; font-size: 1.2em; font-weight: bold; cursor: pointer; 
            transition: all 0.3s; position: relative; overflow: hidden;
        }
        .nav-btn:hover { transform: translateY(-3px); box-shadow: 0 20px 40px rgba(0,0,0,0.3); }
        .nav-btn:active { transform: translateY(-1px); }
        .section { display: none; background: rgba(255,255,255,0.05); padding: 30px; border-radius: 20px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .section.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #4ecdc4; }
        .form-group input, .form-group select { width: 100%; padding: 15px; border: 2px solid rgba(255,255,255,0.2); border-radius: 10px; background: rgba(255,255,255,0.1); color: white; font-size: 1em; }
        .form-group input::placeholder { color: rgba(255,255,255,0.7); }
        .btn { background: linear-gradient(135deg, #ff6b6b, #ff8e8e); border: none; padding: 12px 30px; border-radius: 10px; color: white; font-weight: bold; cursor: pointer; transition: all 0.3s; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
        .btn.danger { background: linear-gradient(135deg, #ff4757, #ff3838); }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: rgba(255,255,255,0.1); border-radius: 15px; overflow: hidden; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1); }
        th { background: rgba(255,255,255,0.2); font-weight: bold; }
        tr:hover { background: rgba(255,255,255,0.1); }
        .loading { text-align: center; padding: 40px; font-size: 1.2em; }
        .error { color: #ff4757; background: rgba(255,71,87,0.2); padding: 15px; border-radius: 10px; margin: 10px 0; }
        .success { color: #2ed573; background: rgba(46,213,115,0.2); padding: 15px; border-radius: 10px; margin: 10px 0; }
        @media (max-width: 768px) { .container { padding: 10px; } .nav-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üî• LUMINUX ADMIN PANEL</h1>
            <p>Full database control using ANON key only (RLS-safe queries)</p>
        </div>

        <!-- STATS -->
        <div id="statsSection" class="stats-grid section active">
            <div class="stat-card">
                <div class="stat-number" id="toolsCount">-</div>
                <div>üõ†Ô∏è Tools</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="usersCount">-</div>
                <div>üë• Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="purchasesCount">-</div>
                <div>üõí Purchases</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="topTools">-</div>
                <div>üî• Top Tool Likes</div>
            </div>
        </div>

        <!-- NAV BUTTONS -->
        <div class="nav-grid">
            <button class="nav-btn" onclick="showSection('tools')">üõ†Ô∏è View All Tools</button>
            <button class="nav-btn" onclick="showSection('users')">üë• View All Users</button>
            <button class="nav-btn" onclick="showSection('purchases')">üõí All Purchases</button>
            <button class="nav-btn" onclick="showSection('addCoins')">üí∞ Add Coins</button>
            <button class="nav-btn" onclick="showSection('createUser')">üÜï Create User</button>
            <button class="nav-btn" onclick="showSection('createTool')">üÜï Create Tool</button>
            <button class="nav-btn danger" onclick="showSection('delete')">üóëÔ∏è Delete Record</button>
            <button class="nav-btn" onclick="showSection('dump')">üíæ Dump All Data</button>
        </div>

        <!-- TOOLS SECTION -->
        <div id="toolsSection" class="section">
            <h2>üõ†Ô∏è All Tools (loadTools() clone)</h2>
            <div id="toolsTable"></div>
        </div>

        <!-- USERS SECTION -->
        <div id="usersSection" class="section">
            <h2>üë• All Users (sorted by coins)</h2>
            <div id="usersTable"></div>
        </div>

        <!-- PURCHASES SECTION -->
        <div id="purchasesSection" class="section">
            <h2>üõí All Purchases</h2>
            <div id="purchasesTable"></div>
        </div>

        <!-- ADD COINS FORM -->
        <div id="addCoinsSection" class="section">
            <h2>üí∞ Add Coins to User</h2>
            <div class="form-group">
                <label>Username:</label>
                <input type="text" id="coinUsername" placeholder="Enter username">
            </div>
            <div class="form-group">
                <label>Amount (+/-):</label>
                <input type="number" id="coinAmount" placeholder="100">
            </div>
            <button class="btn" onclick="addCoins()">‚ûï Add Coins</button>
            <div id="coinResult"></div>
        </div>

        <!-- CREATE USER FORM -->
        <div id="createUserSection" class="section">
            <h2>üÜï Create New User</h2>
            <div class="form-group">
                <label>Email:</label>
                <input type="email" id="newUserEmail" placeholder="user@example.com">
            </div>
            <div class="form-group">
                <label>Username:</label>
                <input type="text" id="newUserName" placeholder="hackerone">
            </div>
            <div class="form-group">
                <label>Password:</label>
                <input type="password" id="newUserPass" placeholder="password123">
            </div>
            <button class="btn" onclick="createUser()">üë§ Create User</button>
            <div id="userResult"></div>
        </div>

        <!-- CREATE TOOL FORM -->
        <div id="createToolSection" class="section">
            <h2>üÜï Create New Tool</h2>
            <div class="form-group">
                <label>Name:</label>
                <input type="text" id="toolName" placeholder="SQLi Scanner">
            </div>
            <div class="form-group">
                <label>Description:</label>
                <input type="text" id="toolDesc" placeholder="Finds SQL injections">
            </div>
            <div class="form-group">
                <label>URL:</label>
                <input type="url" id="toolUrl" placeholder="https://yourtool.com">
            </div>
            <div class="form-group">
                <label>Price (0=free):</label>
                <input type="number" id="toolPrice" placeholder="0" value="0">
            </div>
            <button class="btn" onclick="createTool()">üõ†Ô∏è Create Tool</button>
            <div id="toolResult"></div>
        </div>

        <!-- DELETE FORM -->
        <div id="deleteSection" class="section">
            <h2>üóëÔ∏è Delete Record</h2>
            <div class="form-group">
                <label>Table:</label>
                <select id="deleteTable">
                    <option value="users">Users</option>
                    <option value="tools">Tools</option>
                    <option value="purchases">Purchases</option>
                </select>
            </div>
            <div class="form-group">
                <label>ID:</label>
                <input type="text" id="deleteId" placeholder="user_123 or tool_abc">
            </div>
            <button class="btn danger" onclick="deleteRecord()">üóëÔ∏è CONFIRM DELETE</button>
            <div id="deleteResult"></div>
        </div>

        <!-- DUMP SECTION -->
        <div id="dumpSection" class="section">
            <h2>üíæ Download Full Database</h2>
            <button class="nav-btn" onclick="dumpAllData()">üì• DOWNLOAD JSON DUMP</button>
            <div id="dumpResult"></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://naburjspbrqnymfcmogv.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5hYnVyanNwYnJxbnltZmNtb2d2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5MDY0NDQsImV4cCI6MjA4NjQ4MjQ0NH0.ABGFW9a0Di9jzRgzwrq5kkEPGfy0YNDznnRFW9HSPm70';
        const TABLES = { USERS: 'users', TOOLS: 'tools', PURCHASES: 'purchases', LIKES: 'likes' };

        const HEADERS = {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
            'Content-Type': 'application/json'
        };

        // Show section
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId + 'Section').classList.add('active');
            
            if (sectionId === 'stats') loadStats();
            if (sectionId === 'tools') loadTools();
            if (sectionId === 'users') loadUsers();
            if (sectionId === 'purchases') loadPurchases();
        }

        // API Helper (exact web app queries)
        async function apiRequest(path, options = {}) {
            try {
                const url = new URL(`${SUPABASE_URL}/rest/v1${path}`);
                const res = await fetch(url, {
                    method: options.method || 'GET',
                    headers: { ...HEADERS, ...options.headers },
                    body: options.body ? JSON.stringify(options.body) : null
                });
                return { data: await res.json(), status: res.status };
            } catch(e) {
                return { data: [], status: 500, error: e.message };
            }
        }

        // üî¢ STATS
        async function loadStats() {
            const [tools, users, purchases, topTools] = await Promise.all([
                apiRequest('/tools?select=count'),
                apiRequest('/users?select=count'),
                apiRequest('/purchases?select=count'),
                apiRequest('/tools?order=likes_count.desc&limit=1')
            ]);
            
            document.getElementById('toolsCount').textContent = tools.data[0]?.count || 0;
            document.getElementById('usersCount').textContent = users.data[0]?.count || 0;
            document.getElementById('purchasesCount').textContent = purchases.data[0]?.count || 0;
            document.getElementById('topTools').textContent = topTools.data[0]?.likes_count || 0;
        }

        // üõ†Ô∏è TOOLS (EXACT loadTools())
        async function loadTools() {
            document.getElementById('toolsTable').innerHTML = '<div class="loading">Loading tools...</div>';
            const { data, status } = await apiRequest('/tools?select=*,users(username)&order=created_at.desc');
            
            if (status !== 200 || !Array.isArray(data)) {
                document.getElementById('toolsTable').innerHTML = '<div class="error">‚ùå RLS blocked or no tools</div>';
                return;
            }
            
            const allTools = data.map(t => ({ ...t, likes_count: t.likes_count ?? 0 }));
            let html = `<p>‚úÖ Loaded ${allTools.length} tools</p><table><tr><th>ID</th><th>Name</th><th>Creator</th><th>Price</th><th>Likes</th><th>Free</th></tr>`;
            allTools.slice(0, 50).forEach(t => {
                html += `<tr><td>${t.id.slice(-8)}</td><td>${t.name}</td><td>${t.users?.username || 'anon'}</td><td>${t.price || 0}¬¢</td><td>${t.likes_count}‚ù§Ô∏è</td><td>${t.is_free ? '‚úÖ' : '‚ùå'}</td></tr>`;
            });
            html += '</table>';
            document.getElementById('toolsTable').innerHTML = html;
        }

        // üë• USERS
        async function loadUsers() {
            document.getElementById('usersTable').innerHTML = '<div class="loading">Loading users...</div>';
            const { data } = await apiRequest('/users?select=*,coins,username&order=coins.desc');
            
            let html = `<p>Loaded ${data.length} users</p><table><tr><th>ID</th><th>Username</th><th>Email</th><th>Coins</th><th>Points</th></tr>`;
            data.slice(0, 50).forEach(u => {
                html += `<tr><td>${u.id.slice(-8)}</td><td>${u.username}</td><td>${u.email}</td><td><strong>${u.coins || 0}</strong></td><td>${u.points || 0}</td></tr>`;
            });
            html += '</table>';
            document.getElementById('usersTable').innerHTML = html;
        }

        // üõí PURCHASES
        async function loadPurchases() {
            document.getElementById('purchasesTable').innerHTML = '<div class="loading">Loading purchases...</div>';
            const { data } = await apiRequest('/purchases?select=*,tools(*),users(*)');
            
            let html = `<p>Loaded ${data.length} purchases</p><table><tr><th>ID</th><th>User</th><th>Tool</th><th>Price</th><th>Date</th></tr>`;
            data.slice(0, 50).forEach(p => {
                html += `<tr><td>${p.id.slice(-12)}...</td><td>${p.users?.username || 'anon'}</td><td>${p.tools?.name || 'N/A'}</td><td>${p.amount_paid || 0}¬¢</td><td>${p.purchased_at?.slice(0,16)}</td></tr>`;
            });
            html += '</table>';
            document.getElementById('purchasesTable').innerHTML = html;
        }

        // üí∞ ADD COINS
        async function addCoins() {
            const username = document.getElementById('coinUsername').value;
            const amount = parseInt(document.getElementById('coinAmount').value) || 0;
            
            if (!username) return showResult('coinResult', 'Enter username', 'error');
            
            const { data: users } = await apiRequest(`/users?username=eq.${username}&select=coins`);
            if (!users.length) return showResult('coinResult', 'User not found', 'error');
            
            const newCoins = Math.max(0, (users[0].coins || 0) + amount);
            const { status } = await apiRequest(`/users?username=eq.${username}`, {
                method: 'PATCH'
            }, { coins: newCoins });
            
            showResult('coinResult', status === 204 ? `‚úÖ ${username}: ${newCoins} coins (+${amount})` : '‚ùå Failed', status === 204 ? 'success' : 'error');
        }

        // üÜï CREATE USER
        async function createUser() {
            const email = document.getElementById('newUserEmail').value;
            const username = document.getElementById('newUserName').value;
            const password = document.getElementById('newUserPass').value;
            
            if (!email || !username || !password) return showResult('userResult', 'Fill all fields', 'error');
            
            const hashBuffer = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(password));
            const hash = Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2,'0')).join('');
            
            const { status } = await apiRequest('/users', { 
                method: 'POST',
                headers: { 'Prefer': 'return=representation' }
            }, { email, username, password_hash: hash, coins: 100, points: 0 });
            
            showResult('userResult', status === 201 ? `‚úÖ ${username} created!` : '‚ùå Failed', status === 201 ? 'success' : 'error');
            document.getElementById('createUserSection').querySelectorAll('input').forEach(i => i.value = '');
        }

        // üÜï CREATE TOOL
        async function createTool() {
            const name = document.getElementById('toolName').value;
            const desc = document.getElementById('toolDesc').value;
            const url = document.getElementById('toolUrl').value;
            const price = parseInt(document.getElementById('toolPrice').value) || 0;
            
            if (!name || !desc || !url) return showResult('toolResult', 'Fill all fields', 'error');
            
            const id = `tool_${Date.now()}_${Math.random().toString(36).substr(2, 8)}`;
            const tool = {
                id, name, description: desc, tool_url: url,
                price, is_free: price === 0, likes_count: 0,
                created_at: new Date().toISOString()
            };
            
            const { status } = await apiRequest('/tools', { method: 'POST' }, tool);
            
            showResult('toolResult', status === 201 ? `‚úÖ ${name} created!` : '‚ùå Failed', status === 201 ? 'success' : 'error');
            document.getElementById('createToolSection').querySelectorAll('input').forEach(i => i.value = '');
        }

        // üóëÔ∏è DELETE
        async function deleteRecord() {
            const table = document.getElementById('deleteTable').value;
            const id = document.getElementById('deleteId').value;
            
            if (!id) return showResult('deleteResult', 'Enter ID', 'error');
            
            if (confirm(`Delete ${table}/${id}?`)) {
                const { status } = await apiRequest(`/${table}?id=eq.${id}`, { method: 'DELETE' });
                showResult('deleteResult', status === 204 ? '‚úÖ Deleted' : '‚ùå Failed', status === 204 ? 'success' : 'error');
                document.getElementById('deleteId').value = '';
            }
        }

        // üíæ DUMP
        async function dumpAllData() {
            document.getElementById('dumpResult').innerHTML = '<div class="loading">Dumping...</div>';
            
            const [tools, users, purchases] = await Promise.all([
                apiRequest('/tools?select=*,users(username)'),
                apiRequest('/users?select=*'),
                apiRequest('/purchases?select=*,tools(*),users(*)')
            ]);
            
            const dump = {
                timestamp: new Date().toISOString(),
                tools: tools.data,
                users: users.data,
                purchases: purchases.data
            };
            
            const dataStr = JSON.stringify(dump, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `luminux_dump_${new Date().toISOString().slice(0,10)}.json`;
            link.click();
            
            showResult('dumpResult', '‚úÖ Full database dump downloaded!', 'success');
        }

        // HELPERS
        function showResult(id, message, type) {
            const el = document.getElementById(id);
            el.innerHTML = `<div class="${type}">${message}</div>`;
            setTimeout(() => el.innerHTML = '', 5000);
        }

        // INIT
        loadStats();
    </script>
</body>
</html>
